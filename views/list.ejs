<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body class="grey-bg">


    <%- include('nav.ejs') %>

    <input class="search">
    <button class="search-send">ê²€ìƒ‰</button> 

    <div class="white-bg">

      <% for(let i=0; i< posts.length; i++) { %>
        <div class="list-box">
            <h4>
                <a href="/detail/<%= posts[i]._id %>"><%= posts[i].title %>
                </a>

                <a href="/edit/<%= posts[i]._id %>">âœï¸</a>
                <span class="delete" data-id="<%= posts[i]._id %>">ğŸ—‘ï¸</span>
            </h4>
            <p> <%= posts[i].content %> </p>
        </div>
      <% } %>
    </div> 

    <a href="/list/next/<%= posts[posts.length-1]._id %>">ë‹¤ìŒ</a>


    <script>

      for(let i=0; i< ' <%= posts.length %>'; i++){
        //ajaxì“°ë©´ ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì„œë²„ë¡œ getìš”ì²­í•´ì¤Œ / ì²«ë²ˆì§¸ ê¸€ì˜ ì‚­ì œë²„íŠ¼
        document.querySelectorAll('.delete')[0].addEventListener('click', function(e){
          fetch('/delete?docid='+e.target.dataset.id,{
            method : 'DELETE',
          })
          .then( (r)=>r.text())  //ì´ê±°ë‘ì¤„ ì“°ë©´ ì„œë²„ì—ì„œ ë³´ë‚´ì¤€ ì‘ë‹µê°’ì„ í™•ì¸ê°€ëŠ¥
          .then( (r)=> { console.log(r) })
            //ìœ„ì—ì„œ ì„œë²„ë¡œë¶€í„° ë°›ì€ ë°ì´í„°(r)ë¥¼ ì´ìš©í•´ì„œ ì—¬ê¸°ì„œ ì½”ë“œì§œì„œ ìƒˆ html í˜ì´ì§€ë¥¼
            //í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ ë™ì  ìƒì„± ê°€ëŠ¥í•¨.(í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë Œë”ë§)
          .then( (r)=> { 
            //ì‚­ì œ ì™„ë£Œë˜ì—ˆì„ë•Œ ìƒˆë¡œê³ ì¹¨í•´ì•¼ ë²„íŠ¼ ì‚¬ë¼ì§€ëŠ”ê²Œ ì‹«ì–´ì„œ, ê·¸ëƒ¥ ë²„íŠ¼ ì•ˆë³´ì´ê²Œí•¨
            e.target.parentElement.parentElement.style.display = 'none'
          })
          
        })
      }
    </script>

    <script>
      document.querySelector('.search-send').addEventListener('click', function(){
        let ì…ë ¥í•œê±° = document.querySelector('.search').value
        location.href = '/search?val=' + ì…ë ¥í•œê±°
      })
    </script>

    <script>
      let eventSource
      eventSource = new EventSource('/stream/list')

      eventSource.addEventListener('msg', function (e){
        console.log('ì„œë²„ì—ê²Œ SSE ë°ì´í„° ë°›ìŒ');
        console.log(e.data)
        let ê°€ì ¸ì˜¨ê±° = JSON.parse(e.data)
        document.querySelector('.white-bg').insertAdjacentHTML('afterbegin', `<div class="list-box"><h4>${ê°€ì ¸ì˜¨ê±°.title}</h4></div>`)
      })
    </script> 

  
  </body>
</html>